{% extends "base.html" %}
{% block title %}Chat{% endblock %}

{% block content %}
<div class="mx-auto max-w-3xl rounded-2xl border border-slate-200 bg-white shadow-sm">
  <div class="flex flex-col h-[70vh]">

    <!-- Abas -->
    <div id="chat-tabs" class="flex border-b border-slate-200 bg-slate-50">
        {% if role in ['malote', 'admin'] %}
            <button class="tab-button active px-4 py-2 text-sm font-medium text-primario-700 border-b-2 border-primario-600"
                data-room="malote_admin">Malote</button>
        {% endif %}
        {% if role in ['recepcao', 'admin'] %}
            <button class="tab-button px-4 py-2 text-sm font-medium text-slate-600 hover:text-primario-700"
                data-room="recepcao_admin">Recep√ß√£o</button>
        {% endif %}
        {% if role in ['medico_regulador', 'admin'] %}
            <button class="tab-button px-4 py-2 text-sm font-medium text-slate-600 hover:text-primario-700"
                data-room="regulacao_admin">Regula√ß√£o</button>
        {% endif %}
    </div>
    <!-- Mensagens -->
    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-50"></div>

    <!-- Campo de mensagem -->
    <div class="flex items-center border-t border-slate-200 bg-white p-3">
      <input id="message-input" type="text" placeholder="Digite sua mensagem..."
             class="flex-1 rounded-xl border border-slate-300 px-4 py-2 text-sm focus:border-primario-400 focus:ring-1 focus:ring-primario-400 outline-none" />
      <button id="send-button"
              class="ml-3 rounded-xl bg-primario-600 text-white px-4 py-2 text-sm font-semibold hover:bg-primario-700">
        Enviar
      </button>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
<script>
  const socket = io.connect();
  let currentRoom = "malote_admin";

  const messagesDiv = document.getElementById("messages");
  const messageInput = document.getElementById("message-input");
  const sendButton = document.getElementById("send-button");
  const tabs = document.querySelectorAll(".tab-button");

  // üîπ Carrega mensagens salvas
  async function loadMessages(roomName) {
    console.log("üìú Carregando mensagens da sala:", roomName);
    try {
      const res = await fetch(`/chat/mensagens/${roomName}`);
      const mensagens = await res.json();

      messagesDiv.innerHTML = "";
      mensagens.forEach(msg => {
        const msgElem = document.createElement("div");
        msgElem.classList.add("px-3", "py-2", "rounded-xl", "max-w-[75%]", "text-sm", "shadow-sm");
        msgElem.classList.add(msg.user === "{{ current_user.nome }}" ? "bg-primario-100" : "bg-white", "border", "border-slate-200");
        msgElem.innerHTML = `<strong>${msg.user}:</strong> ${msg.message}`;
        messagesDiv.appendChild(msgElem);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    } catch (e) {
      console.error("‚ùå Erro ao carregar mensagens:", e);
    }
  }

  // üîπ Entra em uma sala
  function joinRoom(roomName) {
    console.log("üîÅ Entrando na sala:", roomName);
    socket.emit("join", { room: roomName });
    currentRoom = roomName;
    tabs.forEach(btn => btn.classList.remove("active", "border-b-2", "border-primario-600", "text-primario-700"));
    document.querySelector(`[data-room="${roomName}"]`)
      .classList.add("active", "border-b-2", "border-primario-600", "text-primario-700");
    loadMessages(roomName);
  }

  // üîπ Troca de aba
  tabs.forEach(btn => {
    btn.addEventListener("click", () => joinRoom(btn.dataset.room));
  });

  // üîπ Conectado
  socket.on("connect", () => {
    console.log("‚úÖ Conectado ao servidor SocketIO");
    joinRoom(currentRoom);
  });

  // üîπ Nova mensagem recebida
  socket.on("message", data => {
    const messageElem = document.createElement("div");
    messageElem.classList.add("px-3", "py-2", "rounded-xl", "max-w-[75%]", "text-sm", "shadow-sm");
    if (data.user === "Voc√™") {
      messageElem.classList.add("bg-primario-100", "self-end", "ml-auto");
    } else {
      messageElem.classList.add("bg-white", "border", "border-slate-200");
    }
    messageElem.innerHTML = `<strong>${data.user}:</strong> ${data.msg}`;
    messagesDiv.appendChild(messageElem);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  // üîπ Enviar mensagem
  sendButton.onclick = function() {
    if (!messageInput.value.trim()) return;
    socket.emit("send_message", { room: currentRoom, message: messageInput.value });
    messageInput.value = "";
  };

  messageInput.addEventListener("keypress", e => {
    if (e.key === "Enter") sendButton.click();
  });
</script>
{% endblock %}
